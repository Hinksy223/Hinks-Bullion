<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Hinks Bullion</title>
<meta name="theme-color" content="#d4af37">
<style>
body {margin:0;font-family:Arial,Helvetica,sans-serif;background-color:#2f2f2f;color:#f0f0f0;display:flex;flex-direction:column;height:100vh;}
header {display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background-color:#1f1f1f;}
header img{height:50px;}
.price-boxes{display:flex;gap:10px;align-items:center;}
.price-box, button.price-box{background-color:#3f3f3f;padding:10px 15px;border-radius:5px;text-align:center;min-width:160px;border:none;color:#f0f0f0;cursor:pointer;}
.price-box.active{border:2px solid #d4af37;}
main{display:flex;flex:1;padding:20px;gap:20px;}
.chart-container{flex:3;background-color:#3f3f3f;border-radius:10px;padding:10px;overflow:hidden;display:flex;flex-direction:column;}
.chart-container iframe{height:400px;}
.graph-toggle{margin-bottom:10px;display:flex;gap:10px;}
.asset-panel{flex:1.5;background-color:#3f3f3f;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:10px;overflow:hidden;min-width:300px;max-width:450px;}
.asset-input-grid {display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px;}
.asset-input-grid input, .asset-input-grid select {width:100%; box-sizing:border-box;}
.asset-button-row {display:flex; gap:10px; margin-bottom:10px;}
input,select,button{padding:8px;border-radius:3px;border:none;}
button{background-color:#d4af37;color:#000;font-weight:bold;cursor:pointer;}
.asset-table-container {flex:1; overflow-y:auto; max-height:400px;} /* scrollable table */
table{width:100%;border-collapse:collapse;color:#f0f0f0;font-size:1em;} 
th,td{padding:4px;text-align:left;border-bottom:1px solid #d4af37;}
th{font-weight:bold;}
.asset-row-line {display:flex;justify-content:space-between;margin-bottom:2px;align-items:center;font-size:1em;} 
.remove-btn {background-color:red;color:#fff;padding:1px 4px;border-radius:3px;cursor:pointer;font-size:0.65em;margin-left:10px;}
footer{text-align:right;padding:5px 20px;font-size:0.8em;}
</style>
</head>
<body>

<header>
  <img id="appLogo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABG0lEQVRYR+3WQQ6CMBQE0Pj+qJ4tHTrwUpu3JZ8RkzC08GBAAAwAt/7VycJzXj0Ei7Cz7U3KUMQgH0YAAtYqS4i3p+J6kJxABlAF6gD6ACnVgHjUDd0Y2iQN6Af0AL7Aw+N9cS7lDr4J2AGzImN2RY6BKwHNACDK2SVkNe5vQeg+Vo2AOgAE9tTHGoh1JvY2AH0JwUjHI1k0d0UBkV7/14ZLYQCVJK6hR1jl+EGCBB6QAKjH2o0XrK9V9a2x9bYJ0AAAAASUVORK5CYII=" alt="Hinks Bullion Logo">
  <div class="price-boxes">
    <button class="price-box active" id="goldBtn">Gold: £<span id="goldPrice">0</span></button>
    <button class="price-box" id="silverBtn">Silver: £<span id="silverPrice">0</span></button>
    <button class="price-box" id="ratioBtn">Gold/Silver Ratio: <span id="ratio">0</span></button>
    <div class="price-box" id="portfolioValue">Portfolio: £0.00</div>
  </div>
  <div id="lastUpdated">Live data from GoldBroker.com</div>
</header>

<main>
  <div class="chart-container">
    <div class="graph-toggle">
      <button id="liveGraphBtn">Live Graph</button>
      <button id="histGraphBtn">Historical Graph</button>
    </div>
    <iframe id="priceChart" src="https://goldbroker.com/widget/live/XAU?currency=GBP&height=400" width="100%" height="100%" scrolling="no" style="border:0;flex:1;"></iframe>
  </div>

  <div class="asset-panel">
    <h3>Asset Management</h3>
    <div class="asset-input-grid">
      <select id="bullionSelect">
        <optgroup label="Gold Bullion">
          <option value="Gold Britannia 1 oz">Gold Britannia 1 oz</option>
          <option value="Gold Sovereign">Gold Sovereign</option>
          <option value="Gold Maple Leaf 1 oz">Gold Maple Leaf 1 oz</option>
          <option value="Gold Krugerrand 1 oz">Gold Krugerrand 1 oz</option>
          <option value="Gold Bar 1 oz">Gold Bar 1 oz</option>
          <option value="Gold Bar 100 g">Gold Bar 100 g</option>
        </optgroup>
        <optgroup label="Silver Bullion">
          <option value="Silver Britannia 1 oz">Silver Britannia 1 oz</option>
          <option value="Silver Maple Leaf 1 oz">Silver Maple Leaf 1 oz</option>
          <option value="Silver Krugerrand 1 oz">Silver Krugerrand 1 oz</option>
          <option value="Silver Bar 1 oz">Silver Bar 1 oz</option>
          <option value="Silver Bar 1 kg">Silver Bar 1 kg</option>
        </optgroup>
      </select>
      <input type="number" id="purchasePrice" placeholder="Purchase Price (£)">
      <input type="date" id="purchaseDate">
      <input type="text" id="purchasedFrom" placeholder="Purchased From">
    </div>

    <!-- Buttons row -->
    <div class="asset-button-row">
      <button id="addAsset">Add Asset</button>
      <button id="generatePDF">Generate PDF</button>
    </div>

    <!-- Scrollable table -->
    <div class="asset-table-container">
      <table id="assetTable">
        <thead><tr><th>Assets</th></tr></thead>
        <tbody id="assetTableBody"></tbody>
      </table>
    </div>

  </div>
</main>

<footer>Hinks Bullion © <span id="year"></span></footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const API_KEY = "goldapi-317hrsmkl5jj28-io";
let assets = JSON.parse(localStorage.getItem('assets')) || [];
let livePrices = { gold:0, silver:0 };

const bullionWeights = {
  "Gold Britannia 1 oz":1, "Gold Sovereign":0.2354, "Gold Maple Leaf 1 oz":1,
  "Gold Krugerrand 1 oz":1, "Gold Bar 1 oz":1, "Gold Bar 100 g":3.215,
  "Silver Britannia 1 oz":1, "Silver Maple Leaf 1 oz":1, "Silver Krugerrand 1 oz":1,
  "Silver Bar 1 oz":1, "Silver Bar 1 kg":32.15
};

const goldBtn = document.getElementById('goldBtn');
const silverBtn = document.getElementById('silverBtn');
const ratioBtn = document.getElementById('ratioBtn');
const priceChart = document.getElementById('priceChart');
const goldPriceSpan = document.getElementById('goldPrice');
const silverPriceSpan = document.getElementById('silverPrice');
const ratioSpan = document.getElementById('ratio');
const liveGraphBtn = document.getElementById('liveGraphBtn');
const histGraphBtn = document.getElementById('histGraphBtn');

async function fetchLivePrices(){
  try{
    const headers={ "x-access-token": API_KEY, "Content-Type":"application/json"};
    const goldResp = await fetch("https://www.goldapi.io/api/XAU/GBP",{headers});
    const silverResp = await fetch("https://www.goldapi.io/api/XAG/GBP",{headers});
    const goldData = await goldResp.json();
    const silverData = await silverResp.json();
    livePrices.gold = parseFloat(goldData.price);
    livePrices.silver = parseFloat(silverData.price);
    updateTopPrices(); renderAssets();
  }catch(e){console.error(e);}
}

function updateTopPrices(){
  goldPriceSpan.textContent = livePrices.gold.toFixed(2);
  silverPriceSpan.textContent = livePrices.silver.toFixed(2);
  ratioSpan.textContent = (livePrices.gold/livePrices.silver).toFixed(2);
}

function setActiveButton(btn){[goldBtn,silverBtn,ratioBtn].forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
function loadLiveChartForMetal(metal){
  if(metal==='gold') priceChart.src="https://goldbroker.com/widget/live/XAU?currency=GBP&height=400";
  else if(metal==='silver') priceChart.src="https://goldbroker.com/widget/live/XAG?currency=GBP&height=400";
  else if(metal==='ratio') priceChart.src="https://goldbroker.com/widget/historical/XAU/XAG?currency=GBP&height=400";
}

goldBtn.onclick=()=>{setActiveButton(goldBtn); loadLiveChartForMetal('gold');};
silverBtn.onclick=()=>{setActiveButton(silverBtn); loadLiveChartForMetal('silver');};
ratioBtn.onclick=()=>{setActiveButton(ratioBtn); loadLiveChartForMetal('ratio');};

liveGraphBtn.onclick=()=>{
  const selected=document.querySelector('.price-box.active').id;
  if(selected==='goldBtn') priceChart.src="https://goldbroker.com/widget/live/XAU?currency=GBP&height=400";
  else if(selected==='silverBtn') priceChart.src="https://goldbroker.com/widget/live/XAG?currency=GBP&height=400";
};
histGraphBtn.onclick=()=>{
  const selected=document.querySelector('.price-box.active').id;
  if(selected==='goldBtn') priceChart.src="https://goldbroker.com/widget/historical/XAU?currency=GBP&height=400";
  else if(selected==='silverBtn') priceChart.src="https://goldbroker.com/widget/historical/XAG?currency=GBP&height=400";
  else if(selected==='ratioBtn') priceChart.src="https://goldbroker.com/widget/historical/XAU/XAG?currency=GBP&height=400";
};

function updatePortfolioValue(){
  let total=assets.reduce((sum,a)=>{const spot=a.metal==='gold'?livePrices.gold:livePrices.silver; return sum+(a.weight*spot);},0);
  document.getElementById('portfolioValue').textContent=`Portfolio: £${total.toFixed(2)}`;
}

function renderAssets(){
  const tbody=document.getElementById('assetTableBody'); tbody.innerHTML='';
  assets.forEach((a,i)=>{
    const spot=a.metal==='gold'?livePrices.gold:livePrices.silver;
    const currentValue=spot*a.weight;
    const changePercent=((currentValue-a.purchasePrice)/a.purchasePrice)*100;
    const color=changePercent>=0?'green':'red';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>
        <div class="asset-row-line">
          <span><strong>${a.bullion} (${a.metal})</strong> | ${a.purchaseDate}</span>
          <span class="remove-btn">X</span>
        </div>
        <div class="asset-row-line">
          <span>Paid: £${a.purchasePrice.toFixed(2)} | From: ${a.purchasedFrom}</span>
          <span class="remove-btn" style="visibility:hidden;">X</span>
        </div>
        <div style="font-size:0.75em; margin-top:2px;">
          Weight: ${a.weight} oz | Current: £${currentValue.toFixed(2)} | <span style="color:${color}">${changePercent.toFixed(2)}%</span>
        </div>
      </td>
    `;
    tr.querySelector('.remove-btn').onclick=()=>{
      assets.splice(i,1); localStorage.setItem('assets',JSON.stringify(assets)); renderAssets();
    };
    tbody.appendChild(tr);
  });
  updatePortfolioValue();
}

document.getElementById('addAsset').onclick=()=>{
  const bullion=document.getElementById('bullionSelect').value;
  const metal=bullion.includes('Gold')?'gold':'silver';
  const weight=bullionWeights[bullion]||1;
  const a={metal,bullion,weight,purchasePrice:parseFloat(document.getElementById('purchasePrice').value)||0,purchaseDate:document.getElementById('purchaseDate').value,purchasedFrom:document.getElementById('purchasedFrom').value};
  assets.push(a); localStorage.setItem('assets',JSON.stringify(assets)); renderAssets();
};

document.getElementById('generatePDF').onclick = async () => {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Load and clean logo
    const logoImg = document.getElementById('appLogo');
    await new Promise(resolve => { if(logoImg.complete) resolve(); else logoImg.onload = resolve; });
    const canvas = document.createElement('canvas');
    canvas.width = logoImg.width;
    canvas.height = logoImg.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(logoImg, 0, 0);
    const cleanBase64 = canvas.toDataURL('image/png').replace(/^data:image\/png;base64,/, '');
    doc.addImage(cleanBase64,'PNG',10,10,40,40);

    // Title & timestamp
    doc.setFontSize(18);
    doc.text("Hinks Bullion Portfolio",60,20);
    const dateStr = new Date().toLocaleString();
    doc.setFontSize(10);
    doc.text(`Generated on: ${dateStr}`,60,28);

    // Asset data
    doc.setFontSize(12);
    let y=60;
    assets.forEach((a,i)=>{
      const spot=a.metal==='gold'?livePrices.gold:livePrices.silver;
      const currentValue=spot*a.weight;
      const changePercent=((currentValue-a.purchasePrice)/a.purchasePrice)*100;
      const color=changePercent>=0?[0,128,0]:[255,0,0];
      doc.setTextColor(...color);
      doc.text(`${i+1}. ${a.bullion} (${a.metal}) Paid £${a.purchasePrice} | Current £${currentValue.toFixed(2)} | ${changePercent.toFixed(2)}% | ${a.purchaseDate}`,10,y);
      y+=8;
      if(y>280){doc.addPage();y=20;}
    });

    doc.save("hinks_bullion_portfolio.pdf");
  } catch(err){
    alert("Error generating PDF: "+err.message);
    console.error(err);
  }
};

document.getElementById('year').textContent=new Date().getFullYear();
renderAssets();
fetchLivePrices();
setInterval(fetchLivePrices,5*60*1000);

if('serviceWorker' in navigator){
  const sw=`const CACHE='hinks-bullion-v1';const FILES=['.'];self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(FILES))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`;
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'text/javascript'})));
}
</script>
</body>
</html>